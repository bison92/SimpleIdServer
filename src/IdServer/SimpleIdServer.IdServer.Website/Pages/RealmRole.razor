@page "/realm/{realmName}/roles/{roleId}"
@using SimpleIdServer.IdServer.Helpers
@using SimpleIdServer.IdServer.Website.Infrastructures
@using SimpleIdServer.IdServer.Website.Resources
@using SimpleIdServer.IdServer.Website.Stores.RealmStore
@using SimpleIdServer.IdServer.Website.Stores.ScopeStore
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<RealmScopesState> realmScopesState
@inject IUrlHelper urlHelper
@inject IDispatcher dispatcher
@inject NotificationService notificationService
@inject IState<RealmRoleState> realmRoleState
@inject ContextMenuService contextMenuService

<div class="mb-1">
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="@urlHelper.GetUrl("/realm/overview")" Text="@Global.Realm" />
        <RadzenBreadCrumbItem Text="@Global.Permissions" />
    </RadzenBreadCrumb>
</div>

<div class="row mb-1">
    <div class="col">
        <RadzenText class="mt-3 mb-3 no-margin" Text="@Global.RealmPermissions" TextStyle="TextStyle.DisplayH3" />
        <p>
            @Global.RealmPermissionsDescription
        </p>
    </div>
    <div class="col-3">
        <RadzenButton Click="@(args => Save())" Icon="save" Text="@Global.Save" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium"></RadzenButton>
    </div>
</div>

<RadzenCard>
    <RadzenDataGrid AllowFiltering="true"
                    AllowColumnResize="true"
                    AllowAlternatingRows="false"
                    AllowSorting="true"
                    PageSize="30"
                    AllowPaging="true"
                    PagerHorizontalAlign="HorizontalAlign.Left"
                    ShowPagingSummary="true"
                    IsLoading="@isLoading"
                    Count="@Permissions.Count"
                    Data="@Permissions"
                    RowRender="@RowRender"
                    TItem="SelectableRealmRolePermission"
                    ColumnWidth="300px">
        <Columns>
            <RadzenDataGridColumn TItem="SelectableRealmRolePermission" Filterable="false" Sortable="false" Width="80px" TextAlign="TextAlign.Center">
                <Template Context="data">
                    <RadzenCheckBox @bind-Value=@data.IsSelected Change="@(args => ToggleChanged(args, data))" TValue="bool" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="SelectableRealmRolePermission" Property="Permission.Component" Filterable="false" Sortable="false" Title="@Global.Component" Width="80px" />
            <RadzenDataGridColumn TItem="SelectableRealmRolePermission" Filterable="false" Sortable="false" Title="@Global.Permissions" Width="80px">
                <Template Context="data">
                    @if(data.Permission.Action == ComponentActions.Manage)
                    {
                        <RadzenBadge Text="@Global.Manage" IsPill="true" />
                    }
                    else
                    {
                        <RadzenBadge Text="@Global.View" IsPill="true" />
                    }
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</RadzenCard>

@code {
    [Parameter]
    public string realmName { get; set; }
    [Parameter]
    public string roleId { get; set; }
    bool selectAll;
    bool isLoading = true;

    List<SelectableRealmRolePermission> Permissions { get; set; } = new List<SelectableRealmRolePermission>();

    record SelectableRealmRolePermission
    {
        public bool IsSelected { get; set; }
        public RealmRolePermission Permission { get; set; }
    }

    record RealmRolePermission
    {
        public string Id { get; set; }
        public string Component { get; set; }
        public ComponentActions Action { get; set; }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        if (firstRender)
        {
            SubscribeToAction<GetAllRealmScopesSuccessAction>((act) =>
            {
                dispatcher.Dispatch(new GetRealmRoleAction { Realm = RealmContext.Instance().Realm, RoleId = roleId });
            });
            SubscribeToAction<GetRealmRoleSuccessAction>((act) =>
            {
                Permissions = realmScopesState.Value.Scopes.Select(s => new SelectableRealmRolePermission
                {
                    IsSelected = act.RealmRole.Scopes.Any(r => r.Scope?.Id == s.Id),
                    Permission = new RealmRolePermission
                    {
                        Component = s.Component,
                        Id = s.Id,
                        Action = s.Action.Value
                    }
                }).ToList();
                isLoading = false;
                StateHasChanged();
            });
            SubscribeToAction<UpdateRealmRoleScopesSuccessAction>((act) =>
            {
                notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Global.RealmRoleScopesUpdated });
                isLoading = false;
                StateHasChanged();
            });
        }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (string.IsNullOrWhiteSpace(roleId)) return;
        dispatcher.Dispatch(new GetAllRealmScopesAction());
    }

    void ToggleChanged(bool isSelected, SelectableRealmRolePermission permission)
    {
        permission.IsSelected = isSelected;
    }

    void RowRender(RowRenderEventArgs<SelectableRealmRolePermission> row)
    {
        const string className = "class";
        if (row.Data.IsSelected)
            row.Attributes.Add(className, "active");
        else if (row.Attributes.ContainsKey(className))
            row.Attributes.Remove(className);
    }

    void Save()
    {
        isLoading = false;
        var selectedScopeIds = Permissions.Where(p => p.IsSelected).Select(p => p.Permission.Id).ToList();
        dispatcher.Dispatch(new UpdateRealmRoleScopesAction { Realm = RealmContext.Instance().Realm, RoleId = roleId, ScopeIds = selectedScopeIds });
        StateHasChanged();
    }
}